var AndraPradesh = [
  "EAST GODAVARI",
  "WEST GODAVARI",
  "GUNTUR",
  "KRISHNA",
  "NELLORE",
  "PRAKASAM",
  "SRIKAKULAM",
  "VISAKHAPATNAM",
  "VIZIANAGARAM",
  "ADILABAD",
  "HYDERABAD",
  "KARIMNAGAR",
  "KHAMMAM",
  "MAHABUBNAGAR",
  "MEDAK",
  "NALGONDA",
  "NIZAMABAD",
  "WARANGAL",
  "RANGAREDDY",
  "ANANTAPUR",
  "CHITTOOR",
  "KUDDAPAH",
  "KURNOOL",
];
var ArunachalPradesh = [
  "LOHIT",
  "EAST SIANG",
  "SUBANSIRI F.D",
  "TIRAP",
  "ANJAW (LOHIT)",
  "LOWER DIBANG",
  "CHANGLANG",
  "PAPUM PARE",
  "LOW SUBANSIRI",
  "UPPER SIANG",
  "WEST SIANG",
  "DIBANG VALLEY",
  "WEST KAMENG",
  "EAST KAMENG",
  "TAWANG(W KAME)",
  "KURUNG KUMEY",
];
var Assam = [
  "CACHAR",
  "DARRANG",
  "GOALPARA",
  "KAMRUP",
  "LAKHIMPUR",
  "NORTH CACHAR",
  "NAGAON",
  "SIVASAGAR",
  "BARPETA",
  "DHUBRI",
  "DIBRUGARH",
  "JORHAT",
  "KARIMGANJ",
  "KOKRAJHAR",
  "SHONITPUR",
  "GOLAGHAT",
  "TINSUKIA",
  "HAILAKANDI",
  "DHEMAJI(LAKHI",
  "KARBI ANGLONG",
  "UDALGURI(DARA",
  "KAMRUP METROP",
  "CHIRANG(BONGAI",
  "BAKSA BARPETA",
  "BONGAIGAON",
  "MORIGAON",
  "NALBARI",
];
var Bihar = [
  "BHAGALPUR",
  "EAST CHAMPARAN",
  "DARBHANGA",
  "GAYA",
  "MUNGER",
  "MUZAFFARPUR",
  "WEST CHAMPARAN",
  "PURNEA",
  "GOPALGANJ",
  "MADHUBANI",
  "AURANGABAD",
  "BEGUSARAI",
  "BHOJPUR",
  "NALANDA",
  "PATNA",
  "KATIHAR",
  "KHAGARIA",
  "SARAN",
  "MADHEPURA",
  "NAWADA",
  "ROHTAS",
  "SAMASTIPUR",
  "SITAMARHI",
  "SIWAN",
  "VAISHALI",
  "JAHANABAD",
  "BUXAR",
  "ARARIA",
  "BANKA",
  "BHABUA",
  "JAMUI",
  "KISHANGANJ",
  "SHEIKHPURA",
  "SUPAUL",
  "LAKHISARAI",
  "SHEOHAR",
  "ARWAL",
  "SAHARSA",
];
var Chhattisgarh = [
  "BASTAR",
  "BILASPUR",
  "DURG",
  "RAIGARH",
  "RAIPUR",
  "SURGUJA",
  "RAJNANDGAON",
  "DANTEWADA",
  "KANKER (NORH",
  "JANJGIR-CHAMP",
  "KORBA",
  "JASHPUR",
  "DHAMTARI",
  "MAHASAMUND",
  "KORIYA",
  "KOWARDHA (KAB",
  "NARAYANPUR",
  "BIJAPUR",
];
var Goa = ["NORTH GOA", "SOUTH GOA"];
var Gujarat = [
  "AHMEDABAD",
  "BANASKANTHA",
  "BARODA",
  "BHARUCH",
  "VALSAD",
  "DANGS",
  "KHEDA",
  "MEHSANA",
  "PANCHMAHALS",
  "SABARKANTHA",
  "SURAT",
  "GANDHINAGAR",
  "NARMADA(BRC)",
  "NAVSARI(VSD)",
  "ANAND(KHR)",
  "PATAN(MHSN)",
  "DAHOD(PNML)",
  "TAPI(SRT)",
  "AMRELI",
  "BHAVNAGAR",
  "JAMNAGAR",
  "JUNAGADH",
  "KUTCH",
  "RAJKOT",
  "SURENDRANAGAR",
  "PORBANDAR",
];
var Haryana = [
  "AMBALA",
  "GURGAON",
  "HISAR",
  "JIND",
  "KARNAL",
  "MAHENDRAGARH",
  "ROHTAK",
  "BHIWANI",
  "FARIDABAD",
  "KURUKSHETRA",
  "SIRSA",
  "SONEPAT(RTK)",
  "YAMUNANAGAR",
  "KAITHAL",
  "PANIPAT",
  "REWARI",
  "FATEHABAD",
  "JHAJJAR",
  "PANCHKULA",
  "MEWAT",
  "PALWAL(FRD)",
];
var HimachalPradesh = [
  "BILASPUR",
  "CHAMBA",
  "KANGRA",
  "KINNAUR",
  "KULLU",
  "LAHUL & SPITI",
  "MANDI",
  "HAMIRPUR",
  "SHIMLA",
  "SIRMAUR",
  "SOLAN",
  "UNA",
];
var JammuKashmir = [
  "ANANTNAG",
  "BARAMULLA",
  "DODA",
  "JAMMU",
  "KATHUA",
  "LADAKH (LEH)",
  "UDHAMPUR",
  "BADGAM",
  "KUPWARA",
  "PULWAMA",
  "SRINAGAR",
  "KARGIL",
  "POONCH",
  "RAJOURI",
  "BANDIPORE",
  "GANDERWAL",
  "KULGAM/(ANT)",
  "SHOPAN",
  "SAMBA",
  "KISTWAR",
  "REASI",
  "RAMBAN(DDA)",
];
var Jharkhand = [
  "BOKARO",
  "DHANBAD",
  "DUMKA",
  "HAZARIBAG",
  "PALAMU",
  "RANCHI",
  "SAHIBGANJ",
  "WEST SINGHBHUM",
  "DEOGHAR",
  "GIRIDIH",
  "GODDA",
  "GUMLA",
  "LOHARDAGA",
  "CHATRA",
  "KODERMA",
  "PAKUR",
  "EAST SINGHBHU",
  "GARHWA",
  "SERAIKELA-KHA",
  "JAMTARA",
  "LATEHAR",
  "SIMDEGA",
  "KHUNTI(RANCHI",
  "RAMGARH",
];
var Karnataka = [
  "UTTAR KANNADA",
  "DAKSHIN KANDA",
  "UDUPI",
  "BELGAM",
  "BIDAR",
  "BIJAPUR",
  "DHARWAD",
  "GULBARGA",
  "YADGIR",
  "RAICHUR",
  "BAGALKOTE",
  "GADAG",
  "HAVERI",
  "KOPPAL",
  "BANGALORE RUR",
  "BELLARY",
  "CHIKMAGALUR",
  "CHITRADURGA",
  "KODAGU",
  "HASSAN",
  "KOLAR",
  "MANDYA",
  "MYSORE",
  "SHIMOGA",
  "TUMKUR",
  "BANGALORE URB",
  "CHAMARAJANAGA",
  "DAVANGERE",
  "RAMNAGAR(BNGR)",
  "CHICKBALLAPUR",
];
var Kerala = [
  "ALAPPUZHA",
  "CANNUR",
  "ERNAKULAM",
  "KOTTAYAM",
  "KOZHIKODE",
  "MALAPPURAM",
  "PALAKKAD",
  "KOLLAM",
  "THRISSUR",
  "THIRUVANANTHA",
  "IDUKKI",
  "KASARGOD",
  "PATHANAMTHITTA",
  "WAYANAD",
];
var MadhyaPradesh = [
  "BETUL",
  "VIDISHA",
  "BHIND",
  "DATIA",
  "DEWAS",
  "DHAR",
  "GUNA",
  "GWALIOR",
  "HOSHANGABAD",
  "INDORE",
  "JHABUA",
  "MANDSAUR",
  "MORENA",
  "KHANDWA",
  "KHARGONE",
  "RAISEN",
  "RAJGARH",
  "RATLAM",
  "SEHORE",
  "SHAJAPUR",
  "SHIVPURI",
  "UJJAIN",
  "BHOPAL",
  "HARDA",
  "NEEMUCH",
  "SHEOPUR",
  "BARWANI",
  "ASHOKNAGAR(GNA",
  "BURHANPUR",
  "ALIRAJPUR(JBA)",
  "BALAGHAT",
  "CHHATARPUR",
  "CHHINDWARA",
  "JABALPUR",
  "MANDLA",
  "NARSINGHPUR",
  "PANNA",
  "REWA",
  "SAGAR",
  "SATNA",
  "SEONI",
  "SHAHDOL",
  "SIDHI",
  "TIKAMGARH",
  "KATNI",
  "DINDORI",
  "UMARIA",
  "DAMOH",
  "ANUPPUR(SHAHD",
  "SINGRAULI",
];
var Maharashtra = [
  "MUMBAI CITY",
  "RAIGAD",
  "RATNAGIRI",
  "THANE",
  "SINDHUDURG",
  "MUMBAI SUB",
  "AHMEDNAGAR",
  "DHULE",
  "JALGAON",
  "KOLHAPUR",
  "NASHIK",
  "PUNE",
  "SANGLI",
  "SATARA",
  "SOLAPUR",
  "NANDURBAR",
  "AURANGABAD",
  "BEED",
  "NANDED",
  "OSMANABAD",
  "PARBHANI",
  "LATUR",
  "JALNA",
  "HINGOLI",
  "AKOLA",
  "AMRAVATI",
  "BHANDARA",
  "BULDHANA",
  "CHANDRAPUR",
  "NAGPUR",
  "YAVATMAL",
  "WARDHA",
  "GADCHIROLI",
  "WASHIM",
  "GONDIA",
];
var Manipur = [
  "IMPHAL EAST",
  "SENAPATI",
  "TAMENGLONG",
  "CHANDEL",
  "UKHRUL",
  "THOUBAL",
  "BISHNUPUR",
  "IMPHAL WEST",
  "CHURACHANDPUR",
];
var Meghalaya = [
  "EAST KHASI HI",
  "JAINTIA HILLS",
  "EAST GARO HIL",
  "RI-BHOI",
  "SOUTH GARO HI",
  "W KHASI HILL",
  "WEST GARO HIL",
];
var Mizoram = [
  "AIZAWL",
  "CHAMPHAI",
  "KOLASIB",
  "LUNGLEI",
  "CHHIMTUIPUI",
  "LAWNGTLAI",
  "MAMIT",
  "SAIHA",
  "SERCHHIP",
];
var Nagaland = [
  "KOHIMA",
  "TUENSANG",
  "MOKOKCHUNG",
  "DIMAPUR",
  "WOKHA",
  "MON",
  "ZUNHEBOTO",
  "PHEK",
  "KEPHRIE",
  "LONGLENG",
  "PEREN",
];
var Orissa = [
  "BALASORE",
  "BOLANGIR",
  "KANDHAMAL/PHU",
  "CUTTACK",
  "DHENKANAL",
  "GANJAM",
  "KALAHANDI",
  "KEONDJHARGARH",
  "KORAPUT",
  "MAYURBHANJ",
  "PURI",
  "SAMBALPUR",
  "SUNDARGARH",
  "BHADRAK",
  "JAJPUR",
  "KENDRAPARA",
  "ANGUL",
  "NAWAPARA",
  "MALKANGIRI",
  "NAWARANGPUR",
  "NAYAGARH",
  "KHURDA",
  "BARGARH",
  "JHARSUGUDA",
  "DEOGARH",
  "RAYAGADA",
  "GAJAPATI",
  "JAGATSINGHAPU",
  "BOUDHGARH",
  "SONEPUR",
];
var Punjab = [
  "AMRITSAR",
  "BATHINDA",
  "FEROZEPUR",
  "GURDASPUR",
  "HOSHIARPUR",
  "JALANDHAR",
  "KAPURTHALA",
  "LUDHIANA",
  "PATIALA",
  "RUPNAGAR",
  "SANGRUR",
  "FARIDKOT",
  "MOGA",
  "NAWANSHAHR",
  "FATEHGARH SAH",
  "MUKTSAR",
  "MANSA",
  "BARNALA",
  "SAS NAGAR(MGA)",
  "TARN TARAN",
];
var Rajasthan = [
  "BARMER",
  "BIKANER",
  "CHURU",
  "SRI GANGANAGA",
  "JAISALMER",
  "JALORE",
  "JODHPUR",
  "NAGAUR",
  "PALI",
  "HANUMANGARH",
  "AJMER",
  "ALWAR",
  "BANSWARA",
  "BHARATPUR",
  "BHILWARA",
  "BUNDI",
  "CHITTORGARH",
  "DUNGARPUR",
  "JAIPUR",
  "JHALAWAR",
  "JHUNJHUNU",
  "KOTA",
  "SAWAI MADHOPUR",
  "SIKAR",
  "SIROHI",
  "TONK",
  "UDAIPUR",
  "DHOLPUR",
  "BARAN",
  "DAUSA",
  "RAJSAMAND",
  "KARAULI",
  "PRATAPGARH(CHT",
];
var Sikkim = ["NORTH SIKKIM", "EAST SIKKIM", "WEST SIKKIM", "SOUTH SIKKIM"];
var TamilNadu = [
  "VELLORE",
  "COIMBATORE",
  "DHARMAPURI",
  "KANYAKUMARI",
  "CHENNAI",
  "MADURAI",
  "NILGIRIS",
  "RAMANATHAPURA",
  "SALEM",
  "THANJAVUR",
  "TIRUCHIRAPPAL",
  "TIRUNELVELI",
  "ERODE",
  "PUDUKKOTTAI",
  "DINDIGUL",
  "VIRUDHUNAGAR",
  "SIVAGANGA",
  "THOOTHUKUDI",
  "TIRUVANNAMALA",
  "NAGAPATTINAM",
  "VILUPPURAM",
  "CUDDALORE",
  "KANCHIPURAM",
  "TIRUVALLUR",
  "THENI",
  "NAMAKKAL",
  "KARUR",
  "PERAMBALUR",
  "TIRUVARUR",
  "KRISHNAGIRI",
  "ARIYALUR",
  "TIRUPUR",
];
var Tripura = ["NORTH TRIPURA", "SOUTH TRIPURA", "WEST TRIPURA", "DHALAI"];
var UttarPradesh = [
  "ALLAHABAD",
  "AZAMGARH",
  "BAHRAICH",
  "BALLIA",
  "BANDA",
  "BARABANKI",
  "BASTI",
  "DEORIA",
  "FAIZABAD",
  "FARRUKHABAD",
  "FATEHPUR",
  "GHAZIPUR",
  "GONDA",
  "GORAKHPUR",
  "HARDOI",
  "JAUNPUR",
  "KANPUR NAGAR",
  "KHERI LAKHIMP",
  "LUCKNOW",
  "MIRZAPUR",
  "PRATAPGARH",
  "RAE BARELI",
  "SITAPUR",
  "SULTANPUR",
  "UNNAO",
  "VARANASI",
  "SONBHADRA",
  "MAHARAJGANJ",
  "MAU",
  "SIDDHARTH NGR",
  "KUSHINAGAR",
  "AMBEDKAR NAGAR",
  "KANNAUJ",
  "BALRAMPUR",
  "KAUSHAMBI",
  "SAHUJI MAHARA",
  "KANPUR DEHAT",
  "CHANDAULI",
  "SANT KABIR NGR",
  "SANT RAVIDAS",
  "SHRAVASTI NGR",
  "AGRA",
  "ALIGARH",
  "BAREILLY",
  "BIJNOR",
  "BADAUN",
  "BULANDSHAHAR",
  "ETAH",
  "ETAWAH",
  "HAMIRPUR",
  "JALAUN",
  "JHANSI",
  "LALITPUR",
  "MAINPURI",
  "MATHURA",
  "MEERUT",
  "MORADABAD",
  "MUZAFFARNAGAR",
  "PILIBHIT",
  "RAMPUR",
  "SAHARANPUR",
  "SHAHJAHANPUR",
  "GHAZIABAD",
  "FIROZABAD",
  "MAHOBA",
  "MAHAMAYA NAGA",
  "AURAIYA",
  "BAGPAT",
  "JYOTIBA PHULE",
  "GAUTAM BUDDHA",
  "KANSHIRAM NAG",
];
var Uttarakhand = [
  "ALMORA",
  "CHAMOLI",
  "DEHRADUN",
  "GARHWAL PAURI",
  "NAINITAL",
  "PITHORAGARH",
  "GARHWAL TEHRI",
  "UTTARKASHI",
  "HARIDWAR",
  "CHAMPAWAT",
  "RUDRAPRAYAG",
  "UDHAM SINGH N",
  "BAGESHWAR",
];
var WestBengal = [
  "COOCH BEHAR",
  "DARJEELING",
  "JALPAIGURI",
  "MALDA",
  "SOUTH DINAJPUR",
  "NORTH DINAJPUR",
  "BANKURA",
  "BIRBHUM",
  "BURDWAN",
  "HOOGHLY",
  "HOWRAH",
  "PURULIA",
  "MURSHIDABAD",
  "NADIA",
  "NORTH 24 PARG",
  "SOUTH 24 PARG",
  "EAST MIDNAPOR",
  "WEST MIDNAPOR",
  "KOLKATA",
];
var AndamanNicobar = ["NICOBAR", "SOUTH ANDAMAN", "N & M ANDAMAN"];
var Chandigarh = ["CHANDIGARH"];
var DadraHaveli = ["DNH"];
var DamanDiu = ["DAMAN", "DIU"];
var Delhi = [
  "NEW DELHI",
  "CENTRAL DELHI",
  "EAST DELHI",
  "NORTH DELHI",
  "NE DELHI",
  "SW DELHI",
  "NW DELHI",
  "SOUTH DELHI",
  "WEST DELHI",
];
var Lakshadweep = ["LAKSHADWEEP"];
var Puducherry = ["PONDICHERRY", "KARAIKAL", "MAHE", "YANAM"];

document.addEventListener("DOMContentLoaded", function () {
  const inputState = document.getElementById("inputState");
  const inputDistrict = document.getElementById("inputDistrict");

  inputState.addEventListener("change", function () {
    const stateSelected = this.value;
    let optionsList = [];
    let htmlString = "";

    switch (stateSelected) {
      case "ANDHRA PRADESH":
        optionsList = AndraPradesh;
        break;
      case "ARUNACHAL PRADESH":
        optionsList = ArunachalPradesh;
        break;
      case "ASSAM":
        optionsList = Assam;
        break;
      case "BIHAR":
        optionsList = Bihar;
        break;
      case "CHATISGARH":
        optionsList = Chhattisgarh;
        break;
      case "GOA":
        optionsList = Goa;
        break;
      case "GUJARAT":
        optionsList = Gujarat;
        break;
      case "HARYANA":
        optionsList = Haryana;
        break;
      case "HIMACHAL":
        optionsList = HimachalPradesh;
        break;
      case "JAMMU AND KASHMIR":
        optionsList = JammuKashmir;
        break;
      case "JHARKHAND":
        optionsList = Jharkhand;
        break;
      case "KARNATAKA":
        optionsList = Karnataka;
        break;
      case "KERALA":
        optionsList = Kerala;
        break;
      case "MADHYA PRADESH":
        optionsList = MadhyaPradesh;
        break;
      case "MAHARASHTRA":
        optionsList = Maharashtra;
        break;
      case "MANIPUR":
        optionsList = Manipur;
        break;
      case "MEGHALAYA":
        optionsList = Meghalaya;
        break;
      case "MIZORAM":
        optionsList = Mizoram;
        break;
      case "NAGALAND":
        optionsList = Nagaland;
        break;
      case "ORISSA":
        optionsList = Orissa;
        break;
      case "PUNJAB":
        optionsList = Punjab;
        break;
      case "RAJASTHAN":
        optionsList = Rajasthan;
        break;
      case "SIKKIM":
        optionsList = Sikkim;
        break;
      case "TAMIL NADU":
        optionsList = TamilNadu;
        break;
      case "TRIPURA":
        optionsList = Tripura;
        break;
      case "UTTARANCHAL":
        optionsList = Uttarakhand;
        break;
      case "UTTAR PRADESH":
        optionsList = UttarPradesh;
        break;
      case "WEST BENGAL":
        optionsList = WestBengal;
        break;
      case "ANDAMAN AND NICOBAR ISLANDS":
        optionsList = AndamanNicobar;
        break;
      case "CHANDIGARH":
        optionsList = Chandigarh;
        break;
      case "DADAR NAGAR HAVELI":
        optionsList = DadraHaveli;
        break;
      case "DAMAN AND DUI":
        optionsList = DamanDiu;
        break;
      case "DELHI":
        optionsList = Delhi;
        break;
      case "LAKSHADWEEP":
        optionsList = Lakshadweep;
        break;
      case "PONDICHERRY":
        optionsList = Puducherry;
        break;
      default:
        optionsList = [];
    }

    // Build the option elements as a string
    for (let i = 0; i < optionsList.length; i++) {
      htmlString += "<option value='" + optionsList[i] + "'>" + optionsList[i] + "</option>";
    }
    inputDistrict.innerHTML = htmlString;
  });
});

function predict() {
  var nitrogen = Number(document.getElementById("nitrogen").value);
  var phosphorous = Number(document.getElementById("phosphorous").value);
  var potassium = Number(document.getElementById("potassium").value);
  var ph = Number(document.getElementById("ph").value);
  var state = document.getElementById("inputState").value;
  var district = document.getElementById("inputDistrict").value;
  var month = document.getElementById("inputMonth").value;

  // Get the values above, put it in a json object and send it to the backend endpoint localhost:8000/predict using fetch
  var data = {
    nitrogen: nitrogen,
    phosphorous: phosphorous,
    potassium: potassium,
    ph: ph,
    state: state,
    district: district,
    month: month,
  };
  
  // Show loading state
  document.getElementById("cropName").innerText = "Loading recommendation...";
  document.getElementById("uncertaintyText").innerText = "Please wait...";
  document.getElementById("explanationList").innerHTML = "";
  document.getElementById("profitList").innerHTML = "";
  document.getElementById("profitBest").innerText = "";
  
  fetch("http://127.0.0.1:8000/predict", {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify(data),
  })
    .then(response => response.json())
    .then(json => {
      console.log("Success:", json);
      
      // Build and show the crop image
      const image = document.createElement("img");
      // Make sure path matches your local folder structure
      image.src = `data/Crops/${json.predicted_crop}.jpg`;
      image.id = "cropImage";
      image.className = "img-fluid rounded";
      
      const imageContainer = document.getElementById("imageContainer");
      if (imageContainer) {
        imageContainer.innerHTML = "";  // clear old
        imageContainer.appendChild(image);
      } else {
        console.error("imageContainer not found in the DOM");
      }

      // 1. Show the crop
      document.getElementById("cropName").innerText = 
      `We recommend planting: ${json.predicted_crop}`;

      // 2. Show uncertainty in plain words
      const uncert = json.uncertainty;
      const predProb = Math.max(...json.probabilities);
      const stdev = uncert[ json.probabilities.indexOf(predProb) ];
      document.getElementById("uncertaintyText").innerText =
      `We're about ${(predProb*100).toFixed(0)}% sure (±${(stdev*100).toFixed(0)}%)`;

      // 3. List the top-2 feature drivers:
      const explain = json.shap_contributions;
      const features = json.shap_contributions.features;
      const values = json.shap_contributions.values;
      // Pair & sort by absolute impact:
      const pairs = features.map((f,i) => [f, values[i]])
                          .sort((a,b)=> Math.abs(b[1]) - Math.abs(a[1]))
                          .slice(0,2);
      const ul = document.getElementById("explanationList");
      ul.innerHTML = pairs.map(
      ([feat,val]) => `<li>Because <strong>${feat}</strong> was ${val>0? 'higher':'lower'} than usual</li>`
      ).join("");

      // profit section:
      const pm = json.profit_means, ps = json.profit_stds;
      const top3 = Object.keys(pm)
        .sort((a,b)=>pm[b]-pm[a]).slice(0,3);
      document.getElementById("profitList").innerHTML = top3.map(c=> {
        return `<li>${c}: ₹${Math.round(pm[c])} ± ₹${Math.round(ps[c])}</li>`;
      }).join("");
      document.getElementById("profitBest").innerText = json.best_crop_profit;
    })
    .catch((error) => {
      console.error("Error:", error);
      document.getElementById("cropName").innerText = "Error fetching recommendation. Please try again.";
    });
}
